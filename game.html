<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27 Poker Club - Game Table</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; 
            background: linear-gradient(135deg, #0b0f1a 0%, #1a1f2e 100%);
            color: #fff; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }
        
        .game-container {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Покерный стол */
        .poker-table {
            width: 1100px;
            height: 600px;
            background: linear-gradient(135deg, #1a5f3e 0%, #0d432a 100%);
            border-radius: 300px;
            position: relative;
            border: 15px solid #8b6914;
            box-shadow: 
                0 0 0 8px #654321,
                0 20px 60px rgba(0, 0, 0, 0.6),
                inset 0 2px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Логотип в центре стола */
        .table-center {
            text-align: center;
            z-index: 1;
        }
        
        .table-logo {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .table-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        /* Места для игроков */
        .player-seat {
            position: absolute;
            width: 140px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        /* Позиции мест вокруг стола (за пределами стола) */
        /* 3 сверху - равномерно распределены */
        .seat-1 { top: -110px; left: calc(50% - 300px); }
        .seat-2 { top: -110px; left: 50%; transform: translateX(-50%); }
        .seat-3 { top: -110px; left: calc(50% + 300px); transform: translateX(-100%); }
        
        /* 2 справа - равномерно по вертикали */
        .seat-4 { top: calc(50% - 120px); right: -180px; transform: translateY(-50%); }
        .seat-5 { bottom: calc(50% - 120px); right: -180px; transform: translateY(50%); }
        
        /* 3 снизу - равномерно распределены */
        .seat-6 { bottom: -110px; left: calc(50% - 300px); }
        .seat-7 { bottom: -110px; left: 50%; transform: translateX(-50%); }
        .seat-8 { bottom: -110px; left: calc(50% + 300px); transform: translateX(-100%); }
        
        /* 2 слева - равномерно по вертикали */
        .seat-9 { top: calc(50% - 120px); left: -180px; transform: translateY(-50%); }
        .seat-10 { bottom: calc(50% - 120px); left: -180px; transform: translateY(50%); }
        
        /* Кнопка "Sit" - овальная форма */
        .sit-button {
            width: 140px;
            height: 70px;
            border-radius: 35px;
            background: rgba(102, 126, 234, 0.3);
            border: 3px solid rgba(102, 126, 234, 0.6);
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .sit-button:hover {
            background: rgba(102, 126, 234, 0.5);
            border-color: #667eea;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .sit-button .seat-number {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        /* Подсказка "Take a sit" */
        .sit-tooltip {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .sit-button:hover .sit-tooltip {
            opacity: 1;
        }
        
        /* Занятое место с игроком */
        .player-info {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .player-info.active {
            display: flex;
        }
        
        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            border: 4px solid #ffd700;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        
        .player-name {
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .player-chips {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #ffd700;
        }
        
        /* Информация о комнате */
        .room-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .room-info .room-id {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
            color: #ffd700;
        }
        
        /* Кнопки в правом верхнем углу */
        .top-right-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }
        
        .leave-button {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid rgba(220, 38, 38, 0.6);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .leave-button:hover {
            background: rgba(220, 38, 38, 0.4);
            border-color: #dc2626;
        }
        
        .leave-seat-button {
            background: rgba(234, 179, 8, 0.2);
            border: 2px solid rgba(234, 179, 8, 0.6);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }
        
        .leave-seat-button.active {
            display: block;
        }
        
        .leave-seat-button:hover {
            background: rgba(234, 179, 8, 0.4);
            border-color: #eab308;
        }
        
        /* Скрываем все кнопки SIT когда игрок сидит */
        body.player-seated .sit-button {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Информация о комнате -->
        <div class="room-info">
            <div class="room-id" id="roomIdDisplay">------</div>
        </div>
        
        <!-- Кнопки в правом верхнем углу -->
        <div class="top-right-buttons">
            <button class="leave-seat-button" id="leaveSeatBtn" onclick="leaveSeat()">Leave Seat</button>
            <button class="leave-button" onclick="leaveRoom()">Leave Game</button>
        </div>
        
        <!-- Покерный стол -->
        <div class="poker-table">
            <!-- Центр стола -->
            <div class="table-center">
                <div class="table-logo">27 POKER CLUB</div>
                <div class="table-subtitle">Texas Hold'em</div>
            </div>
            
            <!-- Места для игроков (10 мест) -->
            <div class="player-seat seat-1" data-seat="1">
                <button class="sit-button" onclick="takeSeat(1)">
                    <div>SIT</div>
                    <div class="seat-number">#1</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-2" data-seat="2">
                <button class="sit-button" onclick="takeSeat(2)">
                    <div>SIT</div>
                    <div class="seat-number">#2</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-3" data-seat="3">
                <button class="sit-button" onclick="takeSeat(3)">
                    <div>SIT</div>
                    <div class="seat-number">#3</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-4" data-seat="4">
                <button class="sit-button" onclick="takeSeat(4)">
                    <div>SIT</div>
                    <div class="seat-number">#4</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-5" data-seat="5">
                <button class="sit-button" onclick="takeSeat(5)">
                    <div>SIT</div>
                    <div class="seat-number">#5</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-6" data-seat="6">
                <button class="sit-button" onclick="takeSeat(6)">
                    <div>SIT</div>
                    <div class="seat-number">#6</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-7" data-seat="7">
                <button class="sit-button" onclick="takeSeat(7)">
                    <div>SIT</div>
                    <div class="seat-number">#7</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-8" data-seat="8">
                <button class="sit-button" onclick="takeSeat(8)">
                    <div>SIT</div>
                    <div class="seat-number">#8</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-9" data-seat="9">
                <button class="sit-button" onclick="takeSeat(9)">
                    <div>SIT</div>
                    <div class="seat-number">#9</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
            
            <div class="player-seat seat-10" data-seat="10">
                <button class="sit-button" onclick="takeSeat(10)">
                    <div>SIT</div>
                    <div class="seat-number">#10</div>
                    <div class="sit-tooltip">Take a seat</div>
                </button>
                <div class="player-info">
                    <div class="player-avatar">P</div>
                    <div class="player-name">Player</div>
                    <div class="player-chips">2000</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Получаем ID комнаты из URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('id');
        
        if (!roomId) {
            alert('No room ID provided');
            window.location.href = 'index.html';
        }
        
        // Отображаем ID комнаты
        document.getElementById('roomIdDisplay').textContent = roomId;
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBStcGa9P5bmE511qBoHonPNANm-ZqkZK4",
            authDomain: "pocker-a2b58.firebaseapp.com",
            databaseURL: "https://pocker-a2b58-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pocker-a2b58",
            storageBucket: "pocker-a2b58.firebasestorage.app",
            messagingSenderId: "73608448533",
            appId: "1:73608448533:web:a9b4b6b5e2c2c0e4f55c1c"
        };
        
        // Инициализация Firebase
        let database;
        let useFirebase = false;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
            useFirebase = true;
            console.log('Firebase connected');
        } catch (error) {
            console.log('Firebase not available, using local storage simulation');
            useFirebase = false;
        }
        
        // Получаем ID игрока
        let playerId = sessionStorage.getItem(`playerId_${roomId}`);
        if (!playerId) {
            alert('Please join the room first via room settings');
            window.location.href = `room.html?id=${roomId}`;
        }
        
        // Получаем данные игрока
        const playerName = sessionStorage.getItem(`playerName_${roomId}`) || 'Player';
        const playerChips = parseInt(sessionStorage.getItem(`playerChips_${roomId}`)) || 2000;
        
        console.log('Player info:', { playerId, playerName, playerChips });
        
        // Переменная для хранения места игрока
        let currentSeat = null;
        
        // Функция для занятия места
        function takeSeat(seatNumber) {
            const seatData = {
                playerId: playerId,
                playerName: playerName,
                chips: playerChips,
                seatNumber: seatNumber,
                timestamp: Date.now()
            };
            
            if (useFirebase) {
                // Проверяем, не занято ли место
                database.ref(`rooms/${roomId}/seats/${seatNumber}`).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        alert('This seat is already taken!');
                        return;
                    }
                    
                    // Проверяем, не сидит ли игрок уже на другом месте
                    database.ref(`rooms/${roomId}/seats`).once('value', (seatsSnapshot) => {
                        const seats = seatsSnapshot.val() || {};
                        for (let seat in seats) {
                            if (seats[seat].playerId === playerId) {
                                alert('You are already seated at seat #' + seat);
                                return;
                            }
                        }
                        
                        // Занимаем место
                        database.ref(`rooms/${roomId}/seats/${seatNumber}`).set(seatData);
                    });
                });
            } else {
                // Для localStorage
                const roomData = JSON.parse(localStorage.getItem(`room_${roomId}`) || '{}');
                roomData.seats = roomData.seats || {};
                
                if (roomData.seats[seatNumber]) {
                    alert('This seat is already taken!');
                    return;
                }
                
                // Проверяем, не сидит ли игрок уже на другом месте
                for (let seat in roomData.seats) {
                    if (roomData.seats[seat].playerId === playerId) {
                        alert('You are already seated at seat #' + seat);
                        return;
                    }
                }
                
                roomData.seats[seatNumber] = seatData;
                localStorage.setItem(`room_${roomId}`, JSON.stringify(roomData));
                renderSeats(roomData.seats);
            }
        }
        
        // Функция для отрисовки мест
        function renderSeats(seats) {
            console.log('Rendering seats:', seats);
            
            // Сначала очищаем все места
            for (let i = 1; i <= 10; i++) {
                const seatElement = document.querySelector(`.seat-${i}`);
                const button = seatElement.querySelector('.sit-button');
                const playerInfo = seatElement.querySelector('.player-info');
                
                button.style.display = 'flex';
                playerInfo.classList.remove('active');
            }
            
            // Затем отображаем занятые места
            for (let seatNum in seats) {
                const seat = seats[seatNum];
                const seatElement = document.querySelector(`.seat-${seatNum}`);
                
                if (!seatElement) continue;
                
                const button = seatElement.querySelector('.sit-button');
                const playerInfo = seatElement.querySelector('.player-info');
                const avatar = playerInfo.querySelector('.player-avatar');
                const name = playerInfo.querySelector('.player-name');
                const chips = playerInfo.querySelector('.player-chips');
                
                // Скрываем кнопку и показываем информацию об игроке
                button.style.display = 'none';
                playerInfo.classList.add('active');
                
                // Заполняем данные игрока
                avatar.textContent = seat.playerName.charAt(0).toUpperCase();
                name.textContent = seat.playerName;
                chips.textContent = seat.chips;
                
                // Подсвечиваем свое место
                if (seat.playerId === playerId) {
                    avatar.style.borderColor = '#00ff00';
                    currentSeat = seatNum;
                    // Показываем кнопку Leave Seat и скрываем все кнопки SIT
                    document.body.classList.add('player-seated');
                    document.getElementById('leaveSeatBtn').classList.add('active');
                } else {
                    avatar.style.borderColor = '#ffd700';
                }
            }
            
            // Если игрок не сидит ни на одном месте
            if (!currentSeat) {
                document.body.classList.remove('player-seated');
                document.getElementById('leaveSeatBtn').classList.remove('active');
            }
        }
        
        // Слушаем изменения мест в Firebase
        if (useFirebase) {
            database.ref(`rooms/${roomId}/seats`).on('value', (snapshot) => {
                const seats = snapshot.val() || {};
                renderSeats(seats);
            });
        } else {
            // Загружаем места из localStorage
            const roomData = JSON.parse(localStorage.getItem(`room_${roomId}`) || '{}');
            renderSeats(roomData.seats || {});
            
            // Polling для обновления
            setInterval(() => {
                const roomData = JSON.parse(localStorage.getItem(`room_${roomId}`) || '{}');
                renderSeats(roomData.seats || {});
            }, 2000);
        }
        
        // Функция для освобождения места
        function leaveSeat() {
            if (!currentSeat) {
                alert('You are not seated!');
                return;
            }
            
            if (useFirebase) {
                database.ref(`rooms/${roomId}/seats/${currentSeat}`).remove();
            } else {
                const roomData = JSON.parse(localStorage.getItem(`room_${roomId}`) || '{}');
                if (roomData.seats && roomData.seats[currentSeat]) {
                    delete roomData.seats[currentSeat];
                    localStorage.setItem(`room_${roomId}`, JSON.stringify(roomData));
                    renderSeats(roomData.seats);
                }
            }
            
            currentSeat = null;
            document.body.classList.remove('player-seated');
            document.getElementById('leaveSeatBtn').classList.remove('active');
        }
        
        // Функция выхода из комнаты
        function leaveRoom() {
            if (confirm('Are you sure you want to leave the game?')) {
                // Удаляем игрока с места если он сидит
                if (currentSeat) {
                    if (useFirebase) {
                        database.ref(`rooms/${roomId}/seats/${currentSeat}`).remove();
                    } else {
                        const roomData = JSON.parse(localStorage.getItem(`room_${roomId}`) || '{}');
                        if (roomData.seats && roomData.seats[currentSeat]) {
                            delete roomData.seats[currentSeat];
                            localStorage.setItem(`room_${roomId}`, JSON.stringify(roomData));
                        }
                    }
                }
                
                // Возвращаемся в настройки комнаты
                window.location.href = `room.html?id=${roomId}`;
            }
        }
    </script>
</body>
</html>
